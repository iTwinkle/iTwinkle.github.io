---
layout: post
title: iOSå†…å­˜ç®¡ç†
date: 2025-12-24
tag: iOS
---

### iOSå†…å­˜ç®¡ç†
<img src="/images/posts/iOSå†…å­˜ç®¡ç†/iOSå†…å­˜ç®¡ç†0.png" > 

ä¸€ã€iOS å†…å­˜ç®¡ç†æ€»ä½“æ¨¡å‹
1ï¸âƒ£ ç‰©ç†å†…å­˜ vs è™šæ‹Ÿå†…å­˜
	â€¢	ç‰©ç†å†…å­˜ï¼ˆRAMï¼‰ï¼šçœŸå®å­˜åœ¨çš„å†…å­˜
	â€¢	è™šæ‹Ÿå†…å­˜ï¼š
	â€¢	æ¯ä¸ªè¿›ç¨‹çœ‹åˆ°çš„æ˜¯è¿ç»­åœ°å€ç©ºé—´
	â€¢	iOS ä½¿ç”¨ VM + é¡µï¼ˆpageï¼‰æœºåˆ¶
	â€¢	é¡µå¤§å°ï¼š16KBï¼ˆarm64ï¼‰

iOS ç‰¹ç‚¹
	â€¢	âŒ æ²¡æœ‰ swap åˆ°ç£ç›˜
	â€¢	âœ… å†…å­˜å‹åŠ›å¤§ â†’ ç›´æ¥æ€è¿›ç¨‹
	â€¢	ä¼˜å…ˆçº§ï¼š
	1.	å‰å° App
	2.	åå°éŸ³é¢‘ / å¯¼èˆª
	3.	åå°æ™®é€š Appï¼ˆç›´æ¥ killï¼‰

ğŸ‘‰ ç»“è®ºï¼š
iOS å†…å­˜æ³„æ¼ â‰  å˜æ…¢ï¼Œè€Œæ˜¯ é—ªé€€ / è¢«ç³»ç»Ÿæ€

äºŒã€ARCï¼ˆAutomatic Reference Countingï¼‰

<img src="/images/posts/iOSå†…å­˜ç®¡ç†/iOSå†…å­˜ç®¡ç†5.png" > 
<img src="/images/posts/iOSå†…å­˜ç®¡ç†/iOSå†…å­˜ç®¡ç†4.png" > 

1ï¸âƒ£ ARC æœ¬è´¨

ARC ä¸æ˜¯ GCï¼Œæ˜¯ ç¼–è¯‘æœŸæ’å…¥ retain / release

```
[obj retain];
[obj release];
```
ç”±ç¼–è¯‘å™¨åœ¨åˆé€‚ä½ç½®è‡ªåŠ¨æ’å…¥ã€‚

2ï¸âƒ£ å¼•ç”¨è®¡æ•°è§„åˆ™ï¼ˆæ ¸å¿ƒï¼‰

3ï¸âƒ£ dealloc è°ƒç”¨æ—¶æœº
	â€¢	å¼•ç”¨è®¡æ•° == 0
	â€¢	ä¸ä¼šç«‹å³é‡Šæ”¾å†…å­˜ï¼Œè€Œæ˜¯ï¼š
	â€¢	è°ƒç”¨ dealloc
	â€¢	æ ‡è®°å¯å›æ”¶
	â€¢	ç”± RunLoop åˆé€‚æ—¶æœºå›æ”¶

âš ï¸ é¢è¯•ç‚¹

dealloc ä¸ä¸€å®šç«‹å³ free å†…å­˜

ä¸‰ã€å±æ€§ä¿®é¥°ç¬¦ä¸å†…å­˜
<img src="/images/posts/iOSå†…å­˜ç®¡ç†/iOSå†…å­˜ç®¡ç†5.png" > 
1ï¸âƒ£ strong / weak / assign / copy

strong

```
@property (nonatomic, strong) NSObject *obj;

```
	â€¢	æŒæœ‰å¯¹è±¡
	â€¢	å‚ä¸å¼•ç”¨è®¡æ•°
	â€¢	é»˜è®¤ ARC ä¸‹å¯¹è±¡å±æ€§

weak
```
@property (nonatomic, weak) NSObject *obj;
```
	â€¢	ä¸å¢åŠ å¼•ç”¨è®¡æ•°
	â€¢	å¯¹è±¡é‡Šæ”¾ â†’ è‡ªåŠ¨ç½® nilï¼ˆruntime æ”¯æŒï¼‰
	â€¢	è§£å†³å¾ªç¯å¼•ç”¨

âš ï¸ weak åº•å±‚ï¼š
	â€¢	runtime ç»´æŠ¤ weak table
	â€¢	dealloc æ—¶æ¸…ç©ºæ‰€æœ‰ weak æŒ‡é’ˆ

assign
	â€¢	ä¸ç®¡ç†ç”Ÿå‘½å‘¨æœŸ
	â€¢	å¸¸ç”¨äºï¼š
	â€¢	åŸºæœ¬æ•°æ®ç±»å‹
	â€¢	é ARC / unsafe_unretained

ğŸš¨ å±é™©
```
@property (nonatomic, assign) NSObject *obj; // é‡æŒ‡é’ˆé£é™©
```
copyï¼ˆéå¸¸é«˜é¢‘ï¼‰
```
@property (nonatomic, copy) NSString *name;
```
ä½œç”¨ï¼š
	â€¢	é˜²æ­¢å¯å˜å¯¹è±¡è¢«å¤–éƒ¨ä¿®æ”¹

```
NSMutableString *str = ...
self.name = str;
[str appendString:@"xxx"]; // ä¸å½±å“ name
```

	â€¢	NSString / block / NSArray / NSDictionary æ¨è copy

2ï¸âƒ£ block çš„å†…å­˜ç®¡ç†ï¼ˆé‡ç‚¹ï¼‰

block ç±»å‹

ARC ä¸‹
	â€¢	block èµ‹å€¼ç»™ strong / copy â†’ è‡ªåŠ¨æ‹·è´åˆ°å †
```
self.block = ^{
   NSLog(@"%@", self);
};
```
âš ï¸ å¾ªç¯å¼•ç”¨
```
self.block = ^{
   self.name = @"abc";
};
```

è§£å†³ï¼š
```
__weak typeof(self) weakSelf = self;
self.block = ^{
   weakSelf.name = @"abc";
};
```

å››ã€è‡ªåŠ¨é‡Šæ”¾æ± ï¼ˆAutoreleasePoolï¼‰
<img src="/images/posts/iOSå†…å­˜ç®¡ç†/iOSå†…å­˜ç®¡ç†7.png" > 
1ï¸âƒ£ autorelease æ˜¯ä»€ä¹ˆï¼Ÿ
```
NSString *str = [NSString stringWithFormat:@"abc"];
```
	â€¢	å¯¹è±¡åŠ å…¥ å½“å‰ autorelease pool
	â€¢	pool drain æ—¶ç»Ÿä¸€ release

2ï¸âƒ£ RunLoop ä¸ AutoreleasePool

ç³»ç»Ÿè‡ªåŠ¨åˆ›å»º poolï¼š
	â€¢	æ¯æ¬¡ RunLoop å¼€å§‹
	â€¢	æ¯æ¬¡ RunLoop ä¼‘çœ å‰
```
kCFRunLoopEntry
â†’ åˆ›å»º pool
kCFRunLoopBeforeWaiting
â†’ drain pool
```

3ï¸âƒ£ ä¸ºä»€ä¹ˆ for å¾ªç¯è¦æ‰‹åŠ¨åŠ  poolï¼Ÿ
```
for (...) {
   @autoreleasepool {
      // å¤§é‡ä¸´æ—¶å¯¹è±¡
   }
}
```
å¦åˆ™ï¼š
	â€¢	æ‰€æœ‰ä¸´æ—¶å¯¹è±¡å †ç§¯åˆ°ä¸€æ¬¡ RunLoop
	â€¢	ç¬é—´å†…å­˜æš´æ¶¨

ğŸ“Œ éŸ³è§†é¢‘ / å›¾ç‰‡å¤„ç† å¿…è€ƒ + å¿…è¸©å‘

äº”ã€å¾ªç¯å¼•ç”¨ï¼ˆå†…å­˜æ³„æ¼æ ¸å¿ƒæ¥æºï¼‰
1ï¸âƒ£ å¸¸è§å¾ªç¯å¼•ç”¨åœºæ™¯

å¯¹è±¡ â†” block
```
self.block = ^{
   self.doSomething;
};
```

delegate
```
@property (nonatomic, strong) id<XXXDelegate> delegate;
```

åº”ä¸ºï¼š
```
@property (nonatomic, weak) id<XXXDelegate> delegate;
```

2ï¸âƒ£ NSTimer å¾ªç¯å¼•ç”¨ï¼ˆé«˜é¢‘ï¼‰
```
self.timer = [NSTimer scheduledTimerWithTimeInterval:1
    target:self
    selector:@selector(tick)
    userInfo:nil
    repeats:YES];
 ```
å½¢æˆï¼š
```
self â†’ timer â†’ self
```

è§£å†³æ–¹æ¡ˆï¼š
	â€¢	block + weak
	â€¢	ä¸­é—´ proxyï¼ˆNSProxyï¼‰

3ï¸âƒ£ CADisplayLink

å’Œ NSTimer ä¸€æ ·çš„é—®é¢˜ï¼Œæ›´éšè”½


å…­ã€å†…å­˜åˆ†åŒº
<img src="/images/posts/iOSå†…å­˜ç®¡ç†/iOSå†…å­˜ç®¡ç†2.png" > 
<img src="/images/posts/iOSå†…å­˜ç®¡ç†/iOSå†…å­˜ç®¡ç†6.png" > 

ä¸ƒã€å†…å­˜è­¦å‘Šï¼ˆMemory Warningï¼‰

1ï¸âƒ£ ç³»ç»Ÿä½•æ—¶å‘ï¼Ÿ
	â€¢	å¯ç”¨å†…å­˜ä½
	â€¢	VM å‹åŠ›è¿‡å¤§
2ï¸âƒ£ å“åº”æ–¹å¼

UIViewController
```
- (void)didReceiveMemoryWarning {
   [super didReceiveMemoryWarning];
}
```
åº”è¯¥åšä»€ä¹ˆï¼Ÿ
	â€¢	é‡Šæ”¾ï¼š
	â€¢	ç¼“å­˜
	â€¢	å›¾ç‰‡
	â€¢	å¯é‡å»ºæ•°æ®

âŒ ä¸è¦é‡Šæ”¾ï¼š
	â€¢	æ­£åœ¨ä½¿ç”¨çš„æ•°æ®
	â€¢	æ ¸å¿ƒæ¨¡å‹æ•°æ®
å…«ã€å†…å­˜æ³„æ¼ vs é‡æŒ‡é’ˆ

å†…å­˜æ³„æ¼
	â€¢	å¯¹è±¡æ— æ³•é‡Šæ”¾
	â€¢	å†…å­˜æŒç»­å¢é•¿
	â€¢	å¸¸è§åŸå› ï¼šå¾ªç¯å¼•ç”¨
é‡æŒ‡é’ˆ
	â€¢	å¯¹è±¡å·²é‡Šæ”¾
	â€¢	æŒ‡é’ˆä»è®¿é—®
	â€¢	EXC_BAD_ACCESS

æ³„æ¼æ˜¯â€œæ´»ç€ä½†æ²¡ç”¨â€ï¼Œé‡æŒ‡é’ˆæ˜¯â€œæ­»äº†è¿˜ç”¨â€

ä¹ã€å·¥å…·

1ï¸âƒ£ Instruments

Leaks
	â€¢	æŸ¥å¾ªç¯å¼•ç”¨
	â€¢	é ARC / CoreFoundation æ³„æ¼

Allocations
	â€¢	å†…å­˜å¢é•¿è¶‹åŠ¿
	â€¢	å¯¹è±¡ç”Ÿå‘½å‘¨æœŸ

Zombiesï¼ˆè°ƒè¯•ï¼‰
	â€¢	æ•è·é‡æŒ‡é’ˆ
	â€¢	å®šä½å·²é‡Šæ”¾å¯¹è±¡è®¿é—®

2ï¸âƒ£ Xcode Memory Graph
	â€¢	ä¸€çœ¼çœ‹å¼•ç”¨é“¾
	â€¢	block / delegate / timer ä¸€æ¸…äºŒæ¥š

1ï¸âƒ£ C ç»“æ„ä½“ä¸å— ARC ç®¡ç†
```
AVFrame *frame = av_frame_alloc();
```
ğŸ‘‰ å¿…é¡»ï¼š
```
av_frame_free(&frame);
```

2ï¸âƒ£ CVPixelBuffer / OpenGL èµ„æº
	â€¢	å¿…é¡»æ‰‹åŠ¨é‡Šæ”¾
	â€¢	å¦åˆ™ GPU å†…å­˜æ³„æ¼ï¼ˆç³»ç»Ÿæ›´ç‹ ï¼Œç›´æ¥ killï¼‰

<br>
è½¬è½½è¯·æ³¨æ˜ï¼š[iTwinkleçš„åšå®¢](https://itwinkle.github.io/) Â» [iOSå†…å­˜ç®¡ç†](http://iWolf.com/2025/12/iOSå†…å­˜ç®¡ç†)  
   