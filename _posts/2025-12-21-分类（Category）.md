---
layout: post
title: 分类（Category）
date: 2025-12-22
tag: iOS
---

### 分类（Category）

一、什么是 Category（分类）
```
Category 是 Objective-C 提供的一种机制，用于在不修改原类源码、不继承的情况下，为已有类添加方法。

@interface UIView (Corner)
- (void)setRoundCorner;
@end
```

二、Category 能做什么 / 不能做什么
✅ 能做的
	1.	添加实例方法
	2.	添加类方法
	3.	拆分类的代码（按功能模块）
	4.	给系统类“扩展功能”
	5.	方法替换（Method Swizzling）

❌ 不能做的（重点）
```
能力                    是否支持            原因
添加成员变量                ❌         类内存结构已确定
添加属性（自动生成 ivar）    ❌         无法增加 ivar
覆盖原方法（真正覆盖）       ❌         实际是“后加载覆盖”
调用 super                 ❌        Category 不是子类
```
三、Category 添加属性的“真相”

<img src="/images/posts/分类（Category）/分类（Category）1.jpg" > 

1️⃣ 为什么能写 @property 却不报错？

```
@interface UIView (Test)
@property (nonatomic, copy) NSString *name;
@end
```

 只生成 getter / setter 声明，不生成 ivar

 2️⃣ 如何真正实现？

 <img src="/images/posts/分类（Category）/分类（Category）2.jpg" > 

 使用关联对象（Associated Object）

 #import <objc/runtime.h>

```
static const char *kNameKey = "kNameKey";

@implementation UIView (Test)

- (void)setName:(NSString *)name {
    objc_setAssociatedObject(self, kNameKey, name, OBJC_ASSOCIATION_COPY_NONATOMIC);
}

- (NSString *)name {
    return objc_getAssociatedObject(self, kNameKey);
}
@end
```

3️⃣ 关联对象本质
 <img src="/images/posts/分类（Category）/分类（Category）3.jpg" > 

	•	底层是 Runtime 维护的哈希表
	•	key：对象地址
	•	value：关联对象集合
四、Category 的加载顺序（高频面试）

1️⃣ 编译 & 运行时顺序

	1.	先加载类
	2.	再加载分类
	3.	分类方法插入类的方法列表前面

👉 后编译的 Category 会“覆盖”先编译的同名方法

2️⃣ 多个 Category 方法冲突时？

```
@implementation UIView (A)
- (void)test {}
@end

@implementation UIView (B)
- (void)test {}
@end
```
👉 谁最后加载，谁生效（不可控，危险）

📌 面试结论：

Category 方法覆盖是未定义行为，依赖编译顺序

五、Category vs Extension（类扩展）

```
对比点         Category       Extension
文件位置        .h / .m           .m
是否可加 ivar     ❌              ✅
是否可加属性     需关联对象         ✅
是否运行时         是              编译期
是否私有           否              是
```


📌 一句话区分：
Extension 是“匿名子类”，Category 是“运行时拼接”


六、Category + Method Swizzling（必会）

常见用途
	•	统计埋点
	•	防止数组越界
	•	Hook 系统方法
	•	日志监控

```

	+ (void)load {
    Method original = class_getInstanceMethod(self, @selector(viewDidAppear:));
    Method swizzled = class_getInstanceMethod(self, @selector(yq_viewDidAppear:));
    method_exchangeImplementations(original, swizzled);
}
```

⚠️ 注意点
	•	放在 +load
	•	dispatch_once
	•	只 swizzle 一次
	•	避免影响系统行为

七、Category 的底层原理（高级）

Runtime 做了什么？
```
	•	分类被编译成 category_t
	•	启动时调用 _objc_init
	•	attachCategories 把方法列表插入类的方法缓存前面
	```

📌 关键点：

Category 方法优先级高于原类方法


八、Category 的典型使用场景
```
	1.	工具方法
	2.	UIKit 功能扩展
	3.	Model 辅助方法
	4.	模块解耦
	5.	AOP（面向切面编程）
```

九、面试标准总结

Category 是 Objective-C 提供的一种运行时机制，用于在不继承、不修改源码的情况下为类添加方法。它不能添加成员变量，属性需要通过关联对象实现。分类在运行时会被加载并插入到类的方法列表前面，因此可能覆盖原方法或其他分类方法，覆盖顺序依赖编译顺序，属于不安全行为。Category 常用于功能拆分、系统类扩展以及 Method Swizzling。



<br>
转载请注明：[iTwinkle的博客](https://itwinkle.github.io/) » [分类（Category）](http://iWolf.com/2025/12/分类（Category）)  
   