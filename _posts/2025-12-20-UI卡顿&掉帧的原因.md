---
layout: post
title: UI卡顿&掉帧的原因
date: 2025-12-20
tag: iOS
---

### UI卡顿&掉帧的原因
iOS UI 卡顿的本质，是在 16.67ms 的 VSync 周期内，CPU 或 GPU 任一阶段没有完成任务，CPU 侧主要是主线程阻塞和布局绘制开销，GPU 侧主要是离屏渲染、透明混合和复杂合成。
<img src="/images/posts/UI卡顿&掉帧的原因/UI卡顿&掉帧的原因0.png" > 

一、什么是 UI 卡顿 & 掉帧（本质）
1️⃣ 帧率基准
    •   60Hz 屏幕：每帧 16.67ms
    •   120Hz（ProMotion）：每帧 8.33ms

👉 在一帧时间内，CPU + GPU 任一阶段超时，就会掉帧

二、iOS 一帧是如何被渲染出来的（核心）

```
RunLoop 一次循环
 ↓
处理事件（触摸 / Timer / Source）
 ↓
布局（layoutSubviews）
 ↓
绘制（drawRect / CoreGraphics）
 ↓
CPU 生成位图
 ↓
提交给 GPU（纹理、合成）
 ↓
GPU 渲染
 ↓
VSync 同步显示
```
📌 关键点
    •   CPU 阶段卡顿 → 主线程卡
    •   GPU 阶段卡顿 → 掉帧但主线程可能不卡

三、CPU 导致 UI 卡顿（最常见）
<img src="/images/posts/UI卡顿&掉帧的原因/UI卡顿&掉帧的原因1.jpg" >

1️⃣ 主线程做了“不该做的事”
```
❌ 常见错误
    •   JSON 解析
    •   大量字符串处理
    •   文件 IO
    •   图片解码
    •   数据库操作
    •   正则匹配
    •   排序 / 大循环

    // ❌ 在主线程解析大 JSON
NSData *data = ...
NSDictionary *dict = [NSJSONSerialization JSONObjectWithData:data options:0 error:nil];
```
✅ 正确姿势
```
dispatch_async(dispatch_get_global_queue(0, 0), ^{
    // 处理数据
    dispatch_async(dispatch_get_main_queue(), ^{
        // 更新 UI
    });
});
```
UI 更新只能在主线程，但数据处理绝不能在主线程

2️⃣ RunLoop 被阻塞
常见场景
    •   performSelector:afterDelay:
    •   NSTimer 高频触发
    •   同一 RunLoop 周期内任务太多

📌 主线程 RunLoop 过载 → 直接卡 UI

3️⃣ 频繁触发布局 & 刷新

    •   在 layoutSubviews 里：
    •   修改 frame
    •   addSubview
    •   setNeedsLayout

```
- (void)layoutSubviews {
    [super layoutSubviews];
    self.label.text = @"xxx"; // ❌
}

```
📌 会造成：
```

layoutSubviews → setNeedsLayout → 再 layout
```
形成布局死循环

4️⃣ Auto Layout 过度复杂

高风险场景
    •   大量嵌套 view
    •   动态更新约束
    •   tableView / collectionView 中约束太多

📌 AutoLayout 本质是：

线性方程求解（Cassowary）

约束越多 → CPU 越炸

5️⃣ tableView / collectionView 卡顿

常见原因
    •   cell 高度动态计算
    •   cell 内大量子视图
    •   heightForRowAtIndexPath: 复杂逻辑
    •   未使用缓存

✅ 优化关键点
    •   高度缓存
    •   预计算
    •   异步绘制
    •   视图扁平化

四、GPU 导致掉帧（你看不到主线程卡）
<img src="/images/posts/UI卡顿&掉帧的原因/UI卡顿&掉帧的原因2.jpg" >

1️⃣ 离屏渲染（重灾区）

会触发离屏渲染的操作
    •   cornerRadius + masksToBounds
    •   shadow*
    •   shouldRasterize = YES
    •   UIVisualEffectView（模糊）
    •   groupOpacity

📌 离屏渲染 = GPU 多一次 buffer 绘制 + 合成

优化方案
<img src="/images/posts/UI卡顿&掉帧的原因/UI卡顿&掉帧的原因3.jpg" >


2️⃣ 透明度 & 图层混合（Blending）

问题
    •   多层半透明 view
    •   alpha < 1
    •   背景色透明

📌 GPU 需要做 颜色混合计算

✅ 优化
    •   能不透明就不透明
    •   设置 opaque = YES
    •   backgroundColor 非透明

3️⃣ 图片过大 / 未解码

问题
    •   JPEG / PNG 解码发生在主线程
    •   超大纹理上传 GPU

📌 表现
    •   滑动列表突然掉帧

✅ 优化
    •   后台解码
    •   压缩图片
    •   使用 SDWebImage（已处理）

4️⃣ Core Animation 动画过多
    •   同时执行多个动画
    •   复杂 path 动画
    •   3D transform

📌 GPU 压力骤增

五、iOS UI 卡顿的“典型场景总结”

<img src="/images/posts/UI卡顿&掉帧的原因/UI卡顿&掉帧的原因4.jpg" >

六、如何定位 UI 卡顿（实战）

1️⃣ Instruments（必会）

Time Profiler（CPU）
    •   主线程 > 16.67ms
    •   查耗时函数

Core Animation（GPU）
    •   Color Blended Layers
    •   Color Offscreen Rendered

FPS 监控
```
CADisplayLink
```
2️⃣ Xcode Debug 工具
    •   View Debugger
    •   Slow Animations
    •   Main Thread Checker

```

七、系统级优化原则（记住这 8 条）

    1.  主线程只做 UI
    2.  提前计算，避免实时计算
    3.  减少 view 层级
    4.  减少 AutoLayout 复杂度
    5.  避免离屏渲染
    6.  图片要小、要预解码
    7.  滑动期间禁止做重活
    8.  能缓存就缓存
```

<br>
转载请注明：[iTwinkle的博客](https://itwinkle.github.io/) » [UI卡顿&掉帧的原因](http://iWolf.com/2025/12/UI卡顿&掉帧的原因)  
   