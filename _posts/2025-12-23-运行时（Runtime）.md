---
layout: post
title: è¿è¡Œæ—¶ï¼ˆRuntimeï¼‰
date: 2025-12-23
tag: iOS
---

### è¿è¡Œæ—¶ï¼ˆRuntimeï¼‰

<img src="/images/posts/è¿è¡Œæ—¶ï¼ˆRuntimeï¼‰/è¿è¡Œæ—¶ï¼ˆRuntimeï¼‰.jpg" > 

ä¸€ã€ä»€ä¹ˆæ˜¯ Runtimeï¼ˆè¿è¡Œæ—¶ï¼‰

Objective-C æ˜¯ä¸€é—¨â€œè¿è¡Œæ—¶è¯­è¨€â€ã€‚

Runtime = åœ¨ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­ï¼ŒåŠ¨æ€åœ°åˆ›å»ºã€ä¿®æ”¹ã€æŸ¥è¯¢ç±»ã€å¯¹è±¡å’Œæ–¹æ³•çš„æœºåˆ¶

ä¹Ÿå°±æ˜¯è¯´ï¼š
	â€¢	ç¼–è¯‘æœŸï¼šåªåšè¯­æ³•æ£€æŸ¥
	â€¢	è¿è¡ŒæœŸï¼šæ¶ˆæ¯å‘é€ã€æ–¹æ³•æŸ¥æ‰¾ã€åŠ¨æ€ç»‘å®š

Runtime åº•å±‚æ˜¯ C è¯­è¨€ å®ç°çš„ï¼š

```
#import <objc/runtime.h>
```

äºŒã€OC å¯¹è±¡æœ¬è´¨ï¼ˆéå¸¸é‡è¦ï¼‰
<img src="/images/posts/è¿è¡Œæ—¶ï¼ˆRuntimeï¼‰/è¿è¡Œæ—¶ï¼ˆRuntimeï¼‰9.jpg" > 

1ï¸âƒ£ å¯¹è±¡çš„æœ¬è´¨

```
@interface Person : NSObject
@end

Person *p = [[Person alloc] init];
```

æœ¬è´¨ä¸Šï¼š
```
struct objc_object {
    Class isa;
};
```

	â€¢	OC å¯¹è±¡ = C ç»“æ„ä½“
	â€¢	isa æŒ‡é’ˆ æŒ‡å‘ç±»å¯¹è±¡

<img src="/images/posts/è¿è¡Œæ—¶ï¼ˆRuntimeï¼‰/è¿è¡Œæ—¶ï¼ˆRuntimeï¼‰1.jpg" > 

2ï¸âƒ£ ç±»ã€å…ƒç±»ã€å¯¹è±¡å…³ç³»
<img src="/images/posts/è¿è¡Œæ—¶ï¼ˆRuntimeï¼‰/è¿è¡Œæ—¶ï¼ˆRuntimeï¼‰2.jpg" > 

```
å®ä¾‹å¯¹è±¡
   â†“ isa
ç±»å¯¹è±¡ï¼ˆå­˜å±æ€§ã€æ–¹æ³•ï¼‰
   â†“ isa
å…ƒç±»å¯¹è±¡ï¼ˆå­˜ç±»æ–¹æ³•ï¼‰
   â†“ isa
æ ¹å…ƒç±»
   â†“ isa
è‡ªå·±ï¼ˆå½¢æˆé—­ç¯ï¼‰
```
ğŸ“Œ é¢è¯•é«˜é¢‘ï¼š
	â€¢	å¯¹è±¡æ–¹æ³•åœ¨ ç±»å¯¹è±¡
	â€¢	ç±»æ–¹æ³•åœ¨ å…ƒç±»å¯¹è±¡

ä¸‰ã€isa æŒ‡é’ˆ & isa æ··æ·†ï¼ˆarm64ï¼‰

æ—©æœŸï¼š
```
isa â†’ Class
```

ç°åœ¨ï¼ˆarm64ï¼‰ï¼š
```
isa â†’ åŒ…å« Class + å¼•ç”¨è®¡æ•° + æ ‡å¿—ä½ï¼ˆä½åŸŸï¼‰
```

é€šè¿‡ä½è¿ç®—è§£ç ï¼š
```
Class cls = (Class)(obj->isa & ISA_MASK);
```
ğŸ“Œ å¥½å¤„ï¼š
	â€¢	èŠ‚çœå†…å­˜
	â€¢	åŠ å¿«è®¿é—®é€Ÿåº¦

å››ã€æ¶ˆæ¯å‘é€æœºåˆ¶ï¼ˆæœ€æ ¸å¿ƒï¼‰
<img src="/images/posts/è¿è¡Œæ—¶ï¼ˆRuntimeï¼‰/è¿è¡Œæ—¶ï¼ˆRuntimeï¼‰6.jpg" > 

1ï¸âƒ£ OC æ–¹æ³•è°ƒç”¨æœ¬è´¨

<img src="/images/posts/è¿è¡Œæ—¶ï¼ˆRuntimeï¼‰/è¿è¡Œæ—¶ï¼ˆRuntimeï¼‰3.jpg" > 

```
[obj doSomething];
```
ç­‰ä»·äºï¼š

```
objc_msgSend(obj, @selector(doSomething));
```

2ï¸âƒ£ æ¶ˆæ¯æŸ¥æ‰¾æµç¨‹

<img src="/images/posts/è¿è¡Œæ—¶ï¼ˆRuntimeï¼‰/è¿è¡Œæ—¶ï¼ˆRuntimeï¼‰4.jpg" > 

```
objc_msgSend
 â†“
ä» isa æ‰¾åˆ°ç±»å¯¹è±¡
 â†“
æŸ¥æ–¹æ³•ç¼“å­˜ï¼ˆcacheï¼‰
 â†“
æŸ¥ç±»æ–¹æ³•åˆ—è¡¨
 â†“
æŸ¥çˆ¶ç±»æ–¹æ³•åˆ—è¡¨
 â†“
æ‰¾ä¸åˆ° â†’ æ¶ˆæ¯è½¬å‘
```

äº”ã€æ–¹æ³• Method çš„æœ¬è´¨

<img src="/images/posts/è¿è¡Œæ—¶ï¼ˆRuntimeï¼‰/è¿è¡Œæ—¶ï¼ˆRuntimeï¼‰5.jpg" > 

```
struct method_t {
    SEL sel;      // æ–¹æ³•å
    char *types;  // ç¼–ç 
    IMP imp;      // å‡½æ•°æŒ‡é’ˆ
};
```


IMP æœ¬è´¨

```
typedef void (*IMP)(id, SEL, ...);

```

å…­ã€SEL / IMP / Method åŒºåˆ«

<img src="/images/posts/è¿è¡Œæ—¶ï¼ˆRuntimeï¼‰/è¿è¡Œæ—¶ï¼ˆRuntimeï¼‰10.jpg" > 

ä¸ƒã€åŠ¨æ€æ–¹æ³•è§£æï¼ˆDynamic Method Resolutionï¼‰

åœºæ™¯ï¼šæ–¹æ³•ä¸å­˜åœ¨ï¼Œè¿è¡Œæ—¶è¡¥æ•‘

```
+ (BOOL)resolveInstanceMethod:(SEL)sel {
    if (sel == @selector(test)) {
        class_addMethod(self, sel, (IMP)testIMP, "v@:");
        return YES;
    }
    return [super resolveInstanceMethod:sel];
}
```
ğŸ“Œ ä¼˜å…ˆçº§é«˜äºæ¶ˆæ¯è½¬å‘

å…«ã€æ¶ˆæ¯è½¬å‘æœºåˆ¶ï¼ˆä¸‰æ­¥ï¼‰

<img src="/images/posts/è¿è¡Œæ—¶ï¼ˆRuntimeï¼‰/è¿è¡Œæ—¶ï¼ˆRuntimeï¼‰7.jpg" > 

1ï¸âƒ£ åŠ¨æ€æ–¹æ³•è§£æ
```
+ resolveInstanceMethod:
```
2ï¸âƒ£ å¿«é€Ÿè½¬å‘ï¼ˆå¤‡ç”¨æ¥æ”¶è€…ï¼‰
```
- (id)forwardingTargetForSelector:(SEL)aSelector {
    return otherObject;
}
```
3ï¸âƒ£ å®Œæ•´è½¬å‘ï¼ˆNSInvocationï¼‰
```
- (NSMethodSignature *)methodSignatureForSelector:
- (void)forwardInvocation:(NSInvocation *)invocation
```
ğŸ“Œ å¸¸è§åº”ç”¨ï¼š
	â€¢	AOP
	â€¢	å¤šç»§æ‰¿æ¨¡æ‹Ÿ
	â€¢	å®¹é”™é˜²å´©æºƒ

ä¹ã€Method Swizzlingï¼ˆæ–¹æ³•äº¤æ¢ï¼‰

1ï¸âƒ£ åŸç†
```
äº¤æ¢ä¸¤ä¸ªæ–¹æ³•çš„ IMP
```

2ï¸âƒ£ ç¤ºä¾‹
```
Method m1 = class_getInstanceMethod(self, @selector(viewDidLoad));
Method m2 = class_getInstanceMethod(self, @selector(yq_viewDidLoad));
method_exchangeImplementations(m1, m2);
```
3ï¸âƒ£ ä½¿ç”¨åœºæ™¯
	â€¢	ç»Ÿè®¡åŸ‹ç‚¹
	â€¢	é˜²æ­¢æ•°ç»„è¶Šç•Œ
	â€¢	Hook ç³»ç»Ÿæ–¹æ³•

âš ï¸ æ³¨æ„ï¼š
	â€¢	å¿…é¡» dispatch_once
	â€¢	è°¨æ…ä½¿ç”¨ï¼ˆç ´åç³»ç»Ÿè¡Œä¸ºï¼‰

åã€Runtime æ“ä½œç±» & æˆå‘˜

1ï¸âƒ£ è·å–ç±»ä¿¡æ¯
```
Class cls = object_getClass(obj);
```

2ï¸âƒ£ éå†å±æ€§
```
objc_property_t *properties = class_copyPropertyList(cls, &count);
```

3ï¸âƒ£ éå†æ–¹æ³•
```
Method *methods = class_copyMethodList(cls, &count);
```

4ï¸âƒ£ åŠ¨æ€æ·»åŠ å±æ€§ï¼ˆå…³è”å¯¹è±¡ï¼‰

```
objc_setAssociatedObject(self, key, obj, OBJC_ASSOCIATION_RETAIN_NONATOMIC);
```
ğŸ“Œ Category ä¸èƒ½ç›´æ¥æ·»åŠ æˆå‘˜å˜é‡ï¼Œåªèƒ½ç”¨ å…³è”å¯¹è±¡

<br>
è½¬è½½è¯·æ³¨æ˜ï¼š[iTwinkleçš„åšå®¢](https://itwinkle.github.io/) Â» [è¿è¡Œæ—¶ï¼ˆRuntimeï¼‰](http://iWolf.com/2025/12/è¿è¡Œæ—¶ï¼ˆRuntimeï¼‰)  
   