---
layout: post
title: UIç»˜åˆ¶åŸç†&å¼‚æ­¥ç»˜åˆ¶
date: 2025-12-21
tag: iOS
---

### UIç»˜åˆ¶åŸç†

<img src="/images/posts/UIç»˜åˆ¶åŸç†&å¼‚æ­¥ç»˜åˆ¶/UIç»˜åˆ¶åŸç†&å¼‚æ­¥ç»˜åˆ¶1.jpg" > 

ä¸€ã€iOS UI ç»˜åˆ¶çš„ 3 ç§æ–¹å¼ï¼ˆæ ¸å¿ƒï¼‰

<img src="/images/posts/UIç»˜åˆ¶åŸç†&å¼‚æ­¥ç»˜åˆ¶/UIç»˜åˆ¶åŸç†&å¼‚æ­¥ç»˜åˆ¶2.jpg" > 

â‘  ç³»ç»Ÿè‡ªåŠ¨ç»˜åˆ¶ï¼ˆæœ€å¸¸è§ï¼‰

```
setNeedsDisplay
â†“
RunLoop ä¸‹ä¸€è½®
â†“
drawRect:
â†“
Core Graphics ç»˜åˆ¶
```
ç‰¹ç‚¹
    â€¢   åœ¨ ä¸»çº¿ç¨‹
    â€¢   UIKit è‡ªåŠ¨ç®¡ç†
    â€¢   ç®€å•ä½† æ€§èƒ½ä¸€èˆ¬
```
- (void)drawRect:(CGRect)rect {
    [[UIColor redColor] setFill];
    UIRectFill(rect);
}
```
drawRect æ˜¯æ‡’è°ƒç”¨ï¼Œä¸ä¼šæ¯å¸§æ‰§è¡Œ

â‘¡ CALayer å†…å®¹ç»˜åˆ¶ï¼ˆæ€§èƒ½æ›´å¥½ï¼‰
ä¸¤ç§æ–¹å¼

1ï¸âƒ£ delegate å›è°ƒ

```
layer.delegate = self;
[layer setNeedsDisplay];
```
```
layer.delegate = self;
[layer setNeedsDisplay];
```

2ï¸âƒ£ contents ç›´æ¥èµ‹å€¼ï¼ˆæœ€å¿«ï¼‰

```
layer.contents = (__bridge id)image.CGImage;
```
    â€¢   contents æ˜¯æœ€è½»é‡æ–¹å¼
    â€¢   é€‚åˆå›¾ç‰‡ / è§†é¢‘å¸§

 â‘¢GPU ç›´æ¥ç»˜åˆ¶ï¼ˆOpenGL / Metalï¼‰

```
 YUV / RGB
â†“
Shader
â†“
FrameBuffer
â†“
å±å¹•
```
ç‰¹ç‚¹
    â€¢   ä¸èµ° UIKit
    â€¢   æœ€å¼ºæ€§èƒ½
    â€¢   é€‚åˆï¼šè§†é¢‘ã€åŠ¨ç”»ã€ç‰¹æ•ˆ
è§†é¢‘æ’­æ”¾å‡ ä¹ä¸èµ° drawRect
äºŒã€ä¸ºä»€ä¹ˆéœ€è¦ã€Œå¼‚æ­¥ç»˜åˆ¶ã€ï¼Ÿ
åŒæ­¥ç»˜åˆ¶çš„é—®é¢˜
åœºæ™¯
    â€¢   UITableView / UICollectionView
    â€¢   å¯Œæ–‡æœ¬
    â€¢   é˜´å½±ã€åœ†è§’
    â€¢   å¤šå›¾å±‚å åŠ 

åæœ
    â€¢   CPU å¿™
    â€¢   ä¸»çº¿ç¨‹å¡
    â€¢   æ‰å¸§ï¼ˆ< 60 FPSï¼‰

ğŸ“Œ ä¸€å¥è¯

drawRect åœ¨ä¸»çº¿ç¨‹ = å¡é¡¿æ ¹æºä¹‹ä¸€

ä¸‰ã€ä»€ä¹ˆæ˜¯ iOS å¼‚æ­¥ç»˜åˆ¶ï¼Ÿ

<img src="/images/posts/UIç»˜åˆ¶åŸç†&å¼‚æ­¥ç»˜åˆ¶/UIç»˜åˆ¶åŸç†&å¼‚æ­¥ç»˜åˆ¶3.jpg" > 

```
æ ¸å¿ƒæ€æƒ³ï¼š
æŠŠâ€œä½å›¾ç”Ÿæˆâ€æ”¾åˆ°å­çº¿ç¨‹ï¼Œä¸»çº¿ç¨‹åªè´Ÿè´£æ˜¾ç¤º
```

å››ã€å¼‚æ­¥ç»˜åˆ¶çš„ç»å…¸æ–¹æ¡ˆï¼ˆå¿…ä¼šï¼‰
â‘  Core Graphics + å­çº¿ç¨‹ï¼ˆåŸç†çº§ï¼‰

```
å­çº¿ç¨‹
  â†“
UIGraphicsBeginImageContext
  â†“
Core Graphics ç»˜åˆ¶
  â†“
ç”Ÿæˆ UIImage
  â†“
å›ä¸»çº¿ç¨‹
  â†“
layer.contents = image.CGImage
```
ç¤ºä¾‹
```
dispatch_async(dispatch_get_global_queue(0, 0), ^{
    UIGraphicsBeginImageContextWithOptions(size, NO, 0);
    CGContextRef ctx = UIGraphicsGetCurrentContext();

    // ç»˜åˆ¶
    [text drawInRect:rect withAttributes:attrs];

    UIImage *image = UIGraphicsGetImageFromCurrentImageContext();
    UIGraphicsEndImageContext();

    dispatch_async(dispatch_get_main_queue(), ^{
        self.layer.contents = (__bridge id)image.CGImage;
    });
});
```
ğŸ“Œ é¢è¯•é‡ç‚¹
    â€¢   å­çº¿ç¨‹åªèƒ½ç”¨ Core Graphics
    â€¢   ä¸èƒ½ç”¨ UIKitï¼ˆUIViewï¼‰

â‘¡ CATiledLayerï¼ˆç³»ç»Ÿçº§å¼‚æ­¥ç»˜åˆ¶ï¼‰
ç‰¹ç‚¹
    â€¢   è‡ªåŠ¨åˆ†å—
    â€¢   è‡ªåŠ¨å¤šçº¿ç¨‹
    â€¢   å¤§å›¾ / PDF æ¸²æŸ“ç¥å™¨
```
+ (Class)layerClass {
    return [CATiledLayer class];
}
```
ğŸ“Œ é€‚åˆ
    â€¢   åœ°å›¾
    â€¢   è¶…å¤§å›¾ç‰‡
    â€¢   PDF é˜…è¯»å™¨
â‘¢ YYText / AsyncDisplayKitï¼ˆå·¥ä¸šçº§ï¼‰

```
åŸç†
    â€¢   å­çº¿ç¨‹æ’ç‰ˆ + ç»˜åˆ¶
    â€¢   ä¸»çº¿ç¨‹ä»… set contents

ğŸ“Œ é¢è¯•ä¸€å¥è¯

YYLabel æœ¬è´¨æ˜¯å¼‚æ­¥ç”Ÿæˆä½å›¾
```

â‘£ iOS 15+ CALayer å¼‚æ­¥ç»˜åˆ¶èƒ½åŠ›

```
layer.drawsAsynchronously = YES;
```

ğŸ“Œ æ³¨æ„
    â€¢   åªä¼˜åŒ–åˆæˆé˜¶æ®µ
    â€¢   ä¸èƒ½ä»£æ›¿çœŸæ­£çš„å¼‚æ­¥ç»˜åˆ¶

```
iOS UI ç»˜åˆ¶æœ¬è´¨æ˜¯ CPU ç”Ÿæˆä½å›¾ã€GPU åˆæˆæ˜¾ç¤ºã€‚
é»˜è®¤ drawRect åœ¨ä¸»çº¿ç¨‹æ‰§è¡Œï¼Œå½“ç»˜åˆ¶å¤æ‚å†…å®¹æ—¶ä¼šé˜»å¡ UIã€‚
å¼‚æ­¥ç»˜åˆ¶æ˜¯æŠŠ Core Graphics çš„ä½å›¾ç”Ÿæˆæ”¾åˆ°å­çº¿ç¨‹ï¼Œ
ç”Ÿæˆ UIImage åå›ä¸»çº¿ç¨‹é€šè¿‡ CALayer.contents æ˜¾ç¤ºï¼Œ
å¸¸è§äºå¯Œæ–‡æœ¬ã€åˆ—è¡¨ä¼˜åŒ–ï¼ŒYYText å°±æ˜¯å…¸å‹å®ç°ã€‚
```

```

åœ¨è§†é¢‘æ¸²æŸ“åœºæ™¯ä¸­ï¼Œæˆ‘ä»¬é€šå¸¸ç»•è¿‡ UIKitï¼Œ
ç›´æ¥ä½¿ç”¨ OpenGL / Metal åœ¨ GPU ä¾§æ¸²æŸ“ï¼Œ
è¿™æ˜¯æ¯”å¼‚æ­¥ç»˜åˆ¶æ›´åº•å±‚ã€æ€§èƒ½æ›´é«˜çš„æ–¹æ¡ˆã€‚
```


<br>
è½¬è½½è¯·æ³¨æ˜ï¼š[iTwinkleçš„åšå®¢](https://itwinkle.github.io/) Â» [UIç»˜åˆ¶åŸç†&å¼‚æ­¥ç»˜åˆ¶](http://iWolf.com/2025/12/UIç»˜åˆ¶åŸç†&å¼‚æ­¥ç»˜åˆ¶)  
   