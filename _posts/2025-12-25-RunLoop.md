---
layout: post
title: RunLoop
date: 2025-12-25
tag: iOS
---

### RunLoop

<img src="/images/posts/iOS-RunLoop/iOS-RunLoop3.png" > 
ä¸€ã€RunLoop æ˜¯ä»€ä¹ˆï¼Ÿ
<img src="/images/posts/iOS-RunLoop/iOS-RunLoop1.png" > 

RunLoop æœ¬è´¨ï¼šäº‹ä»¶å¾ªç¯æœºåˆ¶
```
RunLoop çš„ä½œç”¨ï¼š
ğŸ‘‰ è®©çº¿ç¨‹æ´»ç€
ğŸ‘‰ åœ¨åˆé€‚çš„æ—¶æœºå¤„ç†äº‹ä»¶
```

å¦‚æœæ²¡æœ‰ RunLoopï¼š
	â€¢	çº¿ç¨‹æ‰§è¡Œå®Œä»»åŠ¡åå°±ä¼š ç›´æ¥é€€å‡º
	â€¢	æ— æ³•æ¥æ”¶ï¼š
	â€¢	è§¦æ‘¸äº‹ä»¶
	â€¢	Timer
	â€¢	ç½‘ç»œå›è°ƒ
	â€¢	PerformSelector
ä¸€å¥è¯æ€»ç»“

RunLoop = while(1) + äº‹ä»¶åˆ†å‘ + ä¼‘çœ å”¤é†’

<img src="/images/posts/iOS-RunLoop/iOS-RunLoop4.png" > 

äºŒã€ä¸ºä»€ä¹ˆä¸»çº¿ç¨‹ä¸ä¼šé€€å‡ºï¼Ÿ
```
int main(int argc, char * argv[]) {
    return UIApplicationMain(argc, argv, nil, NSStringFromClass(AppDelegate.class));
}
```

UIApplicationMain å†…éƒ¨ï¼š
```
int UIApplicationMain(...) {
    // åˆ›å»ºä¸»çº¿ç¨‹ RunLoop
    // while (true) {
    //    å¤„ç†äº‹ä»¶
    //    sleep
    // }
}
```
ğŸ‘‰ ä¸»çº¿ç¨‹ RunLoop ä¸€ç›´åœ¨è·‘ï¼Œæ‰€ä»¥ App ä¸ä¼šé€€å‡º

ä¸‰ã€RunLoop çš„æ ¸å¿ƒç»„æˆç»“æ„

<img src="/images/posts/iOS-RunLoop/iOS-RunLoop2.png" > 

```
RunLoop
 â”œâ”€â”€ Modeï¼ˆæ¨¡å¼ï¼‰
 â”‚    â”œâ”€â”€ Sourceï¼ˆäº‹ä»¶æºï¼‰
 â”‚    â”œâ”€â”€ Timerï¼ˆå®šæ—¶å™¨ï¼‰
 â”‚    â””â”€â”€ Observerï¼ˆç›‘å¬è€…ï¼‰
```
1ï¸âƒ£ Sourceï¼ˆäº‹ä»¶æºï¼‰


Source0
	â€¢	performSelector
	â€¢	dispatch_asyncï¼ˆæœ€ç»ˆï¼‰
	â€¢	æ‰‹åŠ¨å”¤é†’ RunLoop

Source1
	â€¢	è§¦æ‘¸äº‹ä»¶
	â€¢	ç³»ç»Ÿäº‹ä»¶
	â€¢	ç½‘ç»œäº‹ä»¶ï¼ˆåŸºäº portï¼‰

ğŸ“Œ UI è§¦æ‘¸äº‹ä»¶ = Source1


2ï¸âƒ£ Timer

	â€¢	NSTimer
	â€¢	CADisplayLink

ç‰¹ç‚¹ï¼š
	â€¢	ä¾èµ– RunLoop
	â€¢	RunLoop ä¸è·‘ â†’ Timer ä¸èµ°

âš ï¸ å­çº¿ç¨‹ Timer å¸¸è§å‘ï¼š
```
[NSTimer scheduledTimerWithTimeInterval:...]; // âŒ
```
åŸå› ï¼š
ğŸ‘‰ å­çº¿ç¨‹é»˜è®¤ æ²¡æœ‰ RunLoop

```
NSTimer *timer = [NSTimer timerWithTimeInterval:1 target:self selector:@selector(tick) userInfo:nil repeats:YES];
[[NSRunLoop currentRunLoop] addTimer:timer forMode:NSRunLoopCommonModes];
[[NSRunLoop currentRunLoop] run];
```

3ï¸âƒ£ Observerï¼ˆç›‘å¬ RunLoop çŠ¶æ€ï¼‰

Observer å¯ä»¥ç›‘å¬ RunLoop ç”Ÿå‘½å‘¨æœŸ

ğŸ“Œ å¡é¡¿ç›‘æ§ / æ‰å¸§åˆ†ææ ¸å¿ƒå°±æ˜¯ Observer


å››ã€RunLoop Mode
å¸¸è§ Mode

```

Mode                                      ç”¨é€”

NSDefaultRunLoopMode                      é»˜è®¤

UITrackingRunLoopMode                     æ»‘åŠ¨ UIScrollView

NSRunLoopCommonModes                      å ä½é›†åˆ
```
æ»šåŠ¨æ—¶ Timer åœæ­¢çš„åŸå› 

```
[NSTimer scheduledTimerWithTimeInterval:...];
```
é»˜è®¤åŠ å…¥ï¼š
```
NSDefaultRunLoopMode
```
å½“ä½ æ‹–åŠ¨ ScrollViewï¼š
```
RunLoop åˆ‡æ¢åˆ° UITrackingRunLoopMode
```

ğŸ‘‰ Timer ä¸åœ¨å½“å‰ Mode
ğŸ‘‰ æš‚åœ

æ­£ç¡®åšæ³•

```
[[NSRunLoop mainRunLoop] addTimer:timer forMode:NSRunLoopCommonModes];

```
CommonModes åŒ…å«ï¼š
	â€¢	Default
	â€¢	Tracking

äº”ã€RunLoop çš„ä¸€æ¬¡å®Œæ•´å¾ªç¯

```
1. é€šçŸ¥ Observerï¼šEntry
2. å¤„ç† Timer
3. å¤„ç† Source0
4. å¦‚æœæœ‰ Source1 â†’ ç«‹å³å¤„ç†
5. é€šçŸ¥ Observerï¼šBeforeWaiting
6. ä¼‘çœ ï¼ˆmach_msgï¼‰
7. è¢«å”¤é†’
8. é€šçŸ¥ Observerï¼šAfterWaiting
9. å›åˆ°ç¬¬ 2 æ­¥
```
ğŸ“Œ ä¼‘çœ é å†…æ ¸ï¼Œä¸æ˜¯æ­»å¾ªç¯è€— CPU

å…­ã€RunLoop ä¸ GCD çš„å…³ç³»

â—ï¸é‡ç‚¹ç»“è®ºï¼š

GCD ä¸ä¾èµ– RunLoop

ä½†æ˜¯ï¼š
	â€¢	dispatch_async åˆ°ä¸»çº¿ç¨‹
	â€¢	æœ€ç»ˆ ä¼šå”¤é†’ä¸»çº¿ç¨‹ RunLoop

æµç¨‹ï¼š

GCD â†’ Mach Port â†’ Source1 â†’ RunLoop

ä¸ƒã€RunLoop å®æˆ˜åº”ç”¨
1ï¸âƒ£ UITableView / UIScrollView æµç•…æ»šåŠ¨
```
	â€¢	æ»šåŠ¨æ—¶åˆ‡æ¢ Mode
	â€¢	æš‚åœéå¿…è¦ Timer
```
2ï¸âƒ£ å¡é¡¿ç›‘æ§

```
CFRunLoopObserverCreate(
    kCFAllocatorDefault,
    kCFRunLoopAllActivities,
    YES,
    0,
    observerCallback,
    NULL
);
```
é…åˆï¼š
	â€¢	BeforeSources
	â€¢	AfterWaiting
	â€¢	åˆ¤æ–­ä¸»çº¿ç¨‹å¡æ­»

3ï¸âƒ£ å¸¸é©»å­çº¿ç¨‹ï¼ˆéŸ³è§†é¢‘ / è§£ç ï¼‰
 FFmpeg / OpenGL ES éå¸¸å…¸å‹ï¼š


```
NSThread *thread = [[NSThread alloc] initWithBlock:^{
    [[NSRunLoop currentRunLoop] addPort:[NSMachPort port] forMode:NSDefaultRunLoopMode];
    [[NSRunLoop currentRunLoop] run];
}];
[thread start];
```
ğŸ‘‰ è§£ç  / æ¸²æŸ“çº¿ç¨‹å¸¸é©»


<br>
è½¬è½½è¯·æ³¨æ˜ï¼š[iTwinkleçš„åšå®¢](https://itwinkle.github.io/) Â» [RunLoop](http://iWolf.com/2025/12/RunLoop)  
   