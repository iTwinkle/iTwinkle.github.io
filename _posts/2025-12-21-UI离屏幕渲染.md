---
layout: post
title: 离屏幕渲染
date: 2025-12-21
tag: iOS
---

### 离屏幕渲染
<img src="/images/posts/离屏幕渲染/离屏幕渲染.jpg" > 
一、什么是离屏渲染（Offscreen Rendering）

GPU 不能直接在当前屏幕 FrameBuffer 上完成渲染，需要先开辟一个“屏幕外的缓冲区”进行绘制，再拷贝回屏幕显示的过程。

正常渲染（Onscreen）
```

CPU → GPU → 屏幕 FrameBuffer → 显示
```

离屏渲染（Offscreen）

```
CPU → GPU → 离屏 Buffer
               ↓
            合成/拷贝
               ↓
        屏幕 FrameBuffer → 显示
```
📌 关键点
    •   多了一次 Buffer 创建
    •   多了一次 上下文切换
    •   多了一次 GPU 内存拷贝
➡️ 性能开销显著增加

二、为什么离屏渲染会慢？

1️⃣ GPU Pipeline 被打断

GPU 最擅长的是：
    •   顺序批量绘制
    •   最少状态切换

离屏渲染会导致：
    •   FrameBuffer 切换
    •   Render Pass 增加
    •   Pipeline Flush

👉 GPU 无法连续高效渲染

2️⃣ GPU 内存压力大

离屏缓冲区：
    •   本质是 一块纹理
    •   大小 ≈ View 尺寸 × Scale² × 4 bytes

举例（iPhone 15 Pro）：
```
300 × 300 × 3 × 3 × 4 ≈ 3.2 MB
```
频繁创建 = 内存 + 帧率双杀

3️⃣ 额外的合成拷贝
```
Offscreen Texture → Screen FrameBuffer
```
这是一次 GPU Blit 操作
    •   耗时
    •   占用带宽

三、iOS 中哪些情况会触发离屏渲染（重点）

1️⃣ 圆角 + maskToBounds = YES（最常见）

```
view.layer.cornerRadius = 12;
view.layer.masksToBounds = YES;
```
为什么？
    •   GPU 不能直接裁剪当前 Buffer
    •   需要先画完整图层 → 再裁剪

📌 100% 触发离屏渲染

2️⃣ layer.shadow*（阴影）

```
layer.shadowColor = UIColor.blackColor.CGColor;
layer.shadowOpacity = 0.3;
layer.shadowRadius = 10;
```
原因
    •   阴影需要 基于 Alpha 的模糊计算
    •   GPU 需要完整图层信息

📌 默认必触发离屏渲染
✅ 规避方式：shadowPath
```
layer.shadowPath = [UIBezierPath bezierPathWithRect:view.bounds].CGPath;
```
✔️ 避免离屏渲染
✔️ 阴影性能大幅提升

3️⃣ shouldRasterize = YES
```
layer.shouldRasterize = YES;
layer.rasterizationScale = UIScreen.mainScreen.scale;
```
本质
    •   主动开启离屏渲染
    •   将 Layer 缓存成位图

适用场景
    •   复杂但 不经常变化 的视图
    •   如：复杂阴影 + 渐变 + 文本

❌ 滚动列表里慎用

4️⃣ mask（layer.mask）

```
layer.mask = someLayer;
```
    •   Alpha Mask
    •   必须离屏计算

5️⃣ UIBlurEffect / VisualEffectView
```
UIBlurEffect
```
    •   背后本质是 离屏 + 实时模糊
    •   系统高度优化，但仍然昂贵

6️⃣ groupOpacity（透明度混合）

view.alpha = 0.5;

```
在以下情况会触发：
    •   view 有子视图
    •   alpha < 1
    •   子视图需要整体混合
```


<br>
转载请注明：[iTwinkle的博客](https://itwinkle.github.io/) » [离屏幕渲染](http://iWolf.com/2025/12/离屏幕渲染)  
   